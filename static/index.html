<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>citeproc demo</title>
  <style>
    html {
      line-height: 1.3;
      font-family: sans-serif;
      font-size: 16px;
    }
    body {
      margin: 0 auto;
      max-width: 70em;
      padding-left: 10px;
      padding-right: 10px;
      padding-top: 10px;
      padding-bottom: 10px;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    img {
      max-width: 100%;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1.7em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1.7em 0 1.7em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      font-style: italic;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      background-color: #f0f0f0;
      font-size: 85%;
      margin: 0;
      padding: .2em .4em;
    }
    pre {
      padding: 1em;
      background-color: #f0f0f0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
    }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    .line-spacing-2 div.csl-entry {
      line-height: 2;
    }
    .entry-spacing-1 div.csl-entry {
      margin-bottom: 1em;
    }
    .entry-spacing-2 div.csl-entry {
      margin-bottom: 2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
    div.warning {
      border: 3px solid red;
      padding-left: 10px;
      padding-right: 10px;
    }

    div.form {
      display: grid;
      column-gap: 40px;
      grid-template-columns: 60% 40%;
      grid-gap: 10px;
    }
    div.item {
      min-width: 20em;
    }
    textarea {
      width: 100%;
      height: 15em;
      white-space: pre-wrap;
    }
    .editor {
        border: 1px solid lightgray;
        margin: auto;
        height: 160px;
        resize: vertical;
    }
    label {
        font-family: sans-serif;
        font-size: 83%;
        font-weight: bold;
        background-color: #eee;
    }
    button {
        height: 2em;
        width: 8em;
        font-family: sans-serif;
        font-size: 83%;
        font-weight: bold;
        border-radius: 12px;
    }
    #result-citations {
        font-family: Georgia, serif;
        border: 1px solid lightgray;
        padding: 1em;
    }
    #result-bibliography {
        font-family: Georgia, serif;
        border: 1px solid lightgray;
        padding: 1em;
    }
    h3 {
        color: grey;
        margin-top: 10px;
        padding-top: 0;
        font-family: sans-serif;
    }
    a {
        color: inherit;
        text-decoration: none;
    }
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="./data.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>

</head>
<body onload="initialize()">

<div class="form">
  <h3>Demo of the Haskell <a href="https://hackage.haskell.org/package/citeproc">citeproc</a> library</h3>
  <button type="button" onclick="citeproc()">refresh</button>


  <div class="item">
  </select>
  <label for="style">Style</label>
  <select name="style-name" id="style-name" onchange="loadStyle()">
  </select>
  &nbsp;&nbsp;
  <label for="lang">Locale</label>
  <select name="lang" id="lang" onchange="citeproc()">
    <option value="(style default)">(style default)</option>
    <option value="af-ZA">af-ZA</option>
    <option value="ar">ar</option>
    <option value="bg-BG">bg-BG</option>
    <option value="ca-AD">ca-AD</option>
    <option value="cs-CZ">cs-CZ</option>
    <option value="cy-GB">cy-GB</option>
    <option value="da-DK">da-DK</option>
    <option value="de-AT">de-AT</option>
    <option value="de-CH">de-CH</option>
    <option value="de-DE">de-DE</option>
    <option value="el-GR">el-GR</option>
    <option value="en-GB">en-GB</option>
    <option value="en-US">en-US</option>
    <option value="es-CL">es-CL</option>
    <option value="es-ES">es-ES</option>
    <option value="es-MX">es-MX</option>
    <option value="et-EE">et-EE</option>
    <option value="eu">eu</option>
    <option value="fa-IR">fa-IR</option>
    <option value="fi-FI">fi-FI</option>
    <option value="fr-CA">fr-CA</option>
    <option value="fr-FR">fr-FR</option>
    <option value="he-IL">he-IL</option>
    <option value="hr-HR">hr-HR</option>
    <option value="hu-HU">hu-HU</option>
    <option value="id-ID">id-ID</option>
    <option value="is-IS">is-IS</option>
    <option value="it-IT">it-IT</option>
    <option value="ja-JP">ja-JP</option>
    <option value="km-KH">km-KH</option>
    <option value="ko-KR">ko-KR</option>
    <option value="la">la</option>
    <option value="lt-LT">lt-LT</option>
    <option value="lv-LV">lv-LV</option>
    <option value="mn-MN">mn-MN</option>
    <option value="nb-NO">nb-NO</option>
    <option value="nl-NL">nl-NL</option>
    <option value="nn-NO">nn-NO</option>
    <option value="pl-PL">pl-PL</option>
    <option value="pt-BR">pt-BR</option>
    <option value="pt-PT">pt-PT</option>
    <option value="ro-RO">ro-RO</option>
    <option value="ru-RU">ru-RU</option>
    <option value="sk-SK">sk-SK</option>
    <option value="sl-SI">sl-SI</option>
    <option value="sr-RS">sr-RS</option>
    <option value="sv-SE">sv-SE</option>
    <option value="th-TH">th-TH</option>
    <option value="tr-TR">tr-TR</option>
    <option value="uk-UA">uk-UA</option>
    <option value="vi-VN">vi-VN</option>
    <option value="zh-CN">zh-CN</option>
    <option value="zh-TW">zh-TW</option>
  </select>
  <br>
  <div id="style" class="editor">
  </div>
  </div>

  <div class="item">
  <label for="abbreviations">Abbreviations<br></label>
  <div id="abbreviations" class="editor">
{ "default": {
    "container-title": {
        "Lloyd's Law Reports": "Lloyd's Rep",
        "Estates Gazette": "EG",
        "Scots Law Times": "SLT"
    }
  }
}
  </div>
  </div>

  <div class="item">
  <label for="references">References</label>
  &nbsp;&nbsp;
  <label for="sampledata">Load sample data</label>
  <select name="sampledata" id="sampledata" onchange="loadSampleData()">
    <option value="0">sample-0</option>
    <option value="1">sample-1</option>
  </select>
  <br>
  <div id="references" class="editor">
  </div>
  </div>

  <div class="item">
  <label for="citations">Citations<br></label>
  <div id="citations" class="editor">
</div>
  </div>
  <div id="result-bibliography">
  </div>
  <div id="result-citations">
  </div>
<div>



</div>


  </div>

  <script>
    var style = ace.edit("style", { mode: "ace/mode/xml" });
    var editorOpts = {showLineNumbers: false,
                      showFoldWidgets: true,
                      showGutter: false,
                      theme: "ace/theme/textmate",
                      autoScrollEditorIntoView: true,
                      };
    style.setOptions(editorOpts);

    var references = ace.edit("references", { mode: "ace/mode/json" });
    references.setOptions(editorOpts);
    references.setValue(JSON.stringify(sampleReferences[0], null, 2));
    references.clearSelection();

    var abbreviations = ace.edit("abbreviations", { mode: "ace/mode/json" });
    abbreviations.setOptions(editorOpts);

    var citations = ace.edit("citations", { mode: "ace/mode/json" });
    citations.setOptions(editorOpts);
    citations.setValue(JSON.stringify(sampleCitations[0], null, 2));
    citations.clearSelection();

    function renderedCitations(data) {
      var resultCitations = document.getElementById("result-citations");
      var resultBibliography = document.getElementById("result-bibliography");
      resultCitations.innerHTML = "";
      if (data.warnings.length > 0) {
        var warnings = "<div class=\"warning\">\n"
        for (var i=0; i < data.warnings.length; i++) {
          warnings += "<p>" + data.warnings[i] + "</p>\n";
        }
        warnings += "</div>\n";
        resultCitations.innerHTML += warnings;
      }
      for (var i=0; i < data.citations.length; i++) {
        resultCitations.innerHTML +=
          "<p>" + data.citations[i] + "</p>\n";
      }
      var classes = ["csl-bibliography"];
      switch (data['entry-spacing']) {
          case 1: classes.push("entry-spacing-1"); break;
          case 2: classes.push("entry-spacing-2"); break;
          default:
      }
      switch (data['line-spacing']) {
          case 2:  classes.push("line-spacing-2"); break;
          default:
      }
      if (data['hanging-ident']) {
        classes.push("hanging");
      }
      var bib = "";
      bib += "<div class=\"" + classes.join(" ") + "\">\n"
      for (var i=0; i < data.bibliography.length; i++) {
        bib +=
          "<div id=\"ref-" + data.bibliography[i][0] +
          "\" class=\"csl-entry\">\n" + data.bibliography[i][1] +
          "\n</div>\n";
      }
      bib += "</div>\n";
      resultBibliography.innerHTML = bib;
    }

    function loadSampleData() {
      var i = parseInt(document.getElementById("sampledata").value);
      references.setValue(JSON.stringify(sampleReferences[i], null, 2));
      references.clearSelection();
      citations.setValue(JSON.stringify(sampleCitations[i], null, 2));
      citations.clearSelection();
      citeproc();
    }

    function loadStyle() {
      var styleName = document.getElementById("style-name").value;
      fetch('style?name=' + styleName, {
        headers: { "Content-Type": "text/plain" },
        method: 'GET'
      })
       .then(function(response) {
            if (!response.ok) {
              throw Error(response.statusText);
            }
            return response.text()
        })
        .catch(error => console.log(error))
        .then(function(data) {
            style.setValue(data);
            style.clearSelection();
            citeproc();
        })
    }

    function getStyleNames() {
      fetch('styleNames', {
        headers: { "Content-Type": "application/json" },
        method: 'GET'
      })
       .then(function(response) {
            if (!response.ok) {
              throw Error(response.statusText);
            }
            return response.json()
        })
        .catch(error => console.log(error))
        .then(function(data) {
            var styleName = document.getElementById("style-name");
            var opts = [];
            for (var i=0; i < data.length; i++) {
              opts.push("<option value=\"" + data[i] + "\"" +
                ">" + data[i].slice(0,60).replace(".csl","") + "</option>");
            }
          styleName.innerHTML = opts.join();
          loadStyle();
        })
    }

    function citeproc() {
      var cites = [];
      var citesVal = citations.getValue().trim();
      if (citesVal.length > 0) {
        try {
          cites =
            JSON.parse(citesVal);
        } catch(err) {
          alert(err);
        };
      }


      var lang;
      var langVal = document.getElementById("lang").value.trim();

      var abbrevs = {};
      var abbrevsVal = abbreviations.getValue().trim();
      if (abbrevsVal.length > 0) {
        try {
          abbrevs =
            JSON.parse(abbrevsVal);
        } catch(err) {
          alert(err);
        };
      }

      var refs = [];
      var refsVal = references.getValue().trim();
      if (refsVal.length > 0) {
        try {
          refs =
            JSON.parse(refsVal);
        } catch(err) {
          alert(err);
        };
      }

      if (langVal != "(style default)") {
        lang = langVal;
      }

      fetch('citeproc', {
        headers: { "Content-Type": "application/json" },
        method: 'POST',
        body: JSON.stringify({
          style: style.getValue(),
          abbreviations: abbrevs,
          lang: lang,
          references: refs,
          citations: cites,
        }) })
        .then(function(response) {
            if (!response.ok) {
              throw Error(response.statusText);
            }
            return response.json()
        })
        .catch(error => console.log(error))
        .then(data => renderedCitations(data))
      }

    function initialize() {
      getStyleNames();
    }
  </script>


</body>
</html>
